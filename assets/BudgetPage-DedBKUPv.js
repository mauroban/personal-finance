import{u as le,r as $,j as e,d as E,c as R,m as ye,l as P,g as O,V as T}from"./index-DjoC8Tjb.js";import{P as je}from"./PageContainer-Dpv9AWI-.js";import{C as z,a as ie}from"./formatting-AU7roy_L.js";import{f as I}from"./format-zwvYc4J-.js";import{u as ke}from"./useMediaQuery-BhwLU3FH.js";import{P as ve}from"./PeriodSelector-Ccy8X63q.js";const Q=2,Ne=({year:p,month:h})=>{const{categories:M,sources:k,budgets:b,addBudget:N,updateBudget:w,refreshBudgets:D}=le(),[y,o]=$.useState({}),[s,c]=$.useState({}),[x,i]=$.useState(null),[m,B]=$.useState({}),[C,Y]=$.useState({}),[H,X]=$.useState({}),[ce,xe]=$.useState(new Set),q=$.useMemo(()=>M.filter(t=>!t.parentId),[M]);$.useEffect(()=>{const t={},r={},l={},f={};q.forEach(n=>{const d=b.find(a=>a.year===p&&a.month===h&&a.groupId===n.id&&!a.subgroupId&&a.type==="expense");d&&(t[`expense-${n.id}`]=d.amount,d.mode?r[`expense-${n.id}`]=d.mode:d.isRecurrent?r[`expense-${n.id}`]="recurring":r[`expense-${n.id}`]="unique",d.installments&&(l[`expense-${n.id}`]=d.installments),d.isFixedCost&&(f[`expense-${n.id}`]=!0)),M.filter(a=>a.parentId===n.id).forEach(a=>{const u=b.find(v=>v.year===p&&v.month===h&&v.groupId===n.id&&v.subgroupId===a.id&&v.type==="expense");u&&(t[`expense-${n.id}-${a.id}`]=u.amount,u.mode?r[`expense-${n.id}-${a.id}`]=u.mode:u.isRecurrent?r[`expense-${n.id}-${a.id}`]="recurring":r[`expense-${n.id}-${a.id}`]="unique",u.installments&&(l[`expense-${n.id}-${a.id}`]=u.installments),u.isFixedCost&&(f[`expense-${n.id}-${a.id}`]=!0))})}),k.forEach(n=>{const d=b.find(g=>g.year===p&&g.month===h&&g.sourceId===n.id&&g.type==="income");d&&(t[`income-${n.id}`]=d.amount,d.mode?r[`income-${n.id}`]=d.mode:d.isRecurrent?r[`income-${n.id}`]="recurring":r[`income-${n.id}`]="unique",d.installments&&(l[`income-${n.id}`]=d.installments))}),o(t),B(r),Y(l),X(f)},[b,p,h,q,k,M]);const V=t=>t.toLocaleString(z.locale,{style:"currency",currency:z.currency,minimumFractionDigits:z.minimumFractionDigits,maximumFractionDigits:z.maximumFractionDigits}),Z=t=>{const r=Math.floor(t/ie),l=t%ie;return`R$ ${r},${l.toString().padStart(2,"0")}`},ee=t=>{if(x===t&&s[t]!==void 0){const g=parseInt(s[t])||0;return Z(g)}const r=y[t]||0;if(r===0)return"";const l=m[t]||"unique",f=C[t]||1,n=l==="installment"&&f>1?r/f:r,d=Math.round(n*100);return Z(d)},W=(t,r)=>{const l=s[t]||"0";if(r>="0"&&r<="9"){const f=(l+r).replace(/^0+/,"")||"0";c(n=>({...n,[t]:f}))}else if(r==="Backspace"){const f=l.slice(0,-1)||"0";c(n=>({...n,[t]:f}))}},te=t=>{i(t);const r=y[t]||0,l=m[t]||"unique",f=C[t]||1,n=l==="installment"&&f>1?r/f:r,d=Math.round(n*100);c(g=>({...g,[t]:String(d)}))},re=async(t,r,l,f,n)=>{i(null);const g=(parseInt(s[t])||0)/100,a=m[t]||"unique",u=C[t]||Q,v=a==="installment"?g*u:g,A=b.find(L=>r==="expense"?L.year===p&&L.month===h&&L.groupId===l&&L.subgroupId===f&&L.type==="expense":L.year===p&&L.month===h&&L.sourceId===n&&L.type==="income"),F={year:p,month:h,type:r,amount:v,mode:a,installments:a==="installment"?u:void 0,isFixedCost:r==="expense"?H[t]||!1:void 0,...r==="expense"?{groupId:l,subgroupId:f}:{sourceId:n}};A?await w(A.id,F):v>0&&await N(F)},se=async(t,r,l,f,n,d)=>{B(a=>({...a,[t]:r}));const g=b.find(a=>l==="expense"?a.year===p&&a.month===h&&a.groupId===f&&a.subgroupId===n&&a.type==="expense":a.year===p&&a.month===h&&a.sourceId===d&&a.type==="income");g&&await w(g.id,{year:p,month:h,type:l,amount:g.amount,mode:r,installments:r==="installment"?C[t]||1:void 0,isFixedCost:l==="expense"?H[t]||!1:void 0,...l==="expense"?{groupId:f,subgroupId:n}:{sourceId:d}})},ne=async(t,r,l,f,n,d)=>{Y(a=>({...a,[t]:r}));const g=b.find(a=>l==="expense"?a.year===p&&a.month===h&&a.groupId===f&&a.subgroupId===n&&a.type==="expense":a.year===p&&a.month===h&&a.sourceId===d&&a.type==="income");g&&await w(g.id,{year:p,month:h,type:l,amount:g.amount,mode:m[t],installments:r,isFixedCost:l==="expense"?H[t]||!1:void 0,...l==="expense"?{groupId:f,subgroupId:n}:{sourceId:d}})},ue=(t,r,l,f,n,d)=>{X(a=>({...a,[t]:r}));const g=b.find(a=>a.year===p&&a.month===h&&a.groupId===f&&a.subgroupId===n&&a.type==="expense");g&&setTimeout(()=>{w(g.id,{year:p,month:h,type:l,amount:g.amount,mode:m[t]||"unique",installments:g.installments,isFixedCost:r,groupId:f,subgroupId:n}).catch(a=>{P.error("Failed to update fixed cost",{error:a})})},0)},ae=async(t,r,l,f,n)=>{const d=b.find(u=>r==="expense"?u.year===p&&u.month===h&&u.groupId===l&&u.subgroupId===f&&u.type==="expense":u.year===p&&u.month===h&&u.sourceId===n&&u.type==="income");if(!d||!d.id)return;const g=d.mode||(d.isRecurrent?"recurring":"unique"),a=R(p,h);if(g==="recurring"||g==="installment"){const v=(await E.budgets.toArray()).filter(j=>r==="expense"?j.type==="expense"&&j.groupId===l&&j.subgroupId===f:j.type==="income"&&j.sourceId===n),A=v.length>0?Math.min(...v.map(j=>R(j.year,j.month))):a;let F=a;g==="installment"&&d.installments&&(F=A+d.installments);const L=v.filter(j=>{const S=R(j.year,j.month);return S<a&&(g==="recurring"||S<F)}),pe=v.filter(j=>{const S=R(j.year,j.month);return S>=a&&(g==="recurring"||S<F)}),he=new Set(L.map(j=>R(j.year,j.month))),J=[];for(let j=A;j<a;j++)!he.has(j)&&(g==="recurring"||j<F)&&J.push(j);for(const j of J){const{year:S,month:fe}=ye(j),be={year:S,month:fe,type:r,amount:d.amount,mode:"unique",...r==="expense"?{groupId:l,subgroupId:f}:{sourceId:n}};await E.budgets.add(be)}for(const j of L)j.id&&await E.budgets.update(j.id,{...j,mode:"unique",installments:void 0,installmentNumber:void 0,isRecurrent:!1});const oe=pe.map(j=>j.id).filter(j=>j!==void 0);await E.budgets.bulkDelete(oe),P.debug("Budget mode change completed",{createdPastMonths:J.length,convertedPastBudgets:L.length,deletedFutureBudgets:oe.length})}else await E.budgets.delete(d.id);await D(),o(u=>{const v={...u};return delete v[t],v}),B(u=>{const v={...u};return delete v[t],v}),Y(u=>{const v={...u};return delete v[t],v})},ge=t=>{xe(r=>{const l=new Set(r);return l.has(t)?l.delete(t):l.add(t),l})},de=$.useMemo(()=>{const t=new Map;return M.forEach(r=>{r.parentId&&(t.has(r.parentId)||t.set(r.parentId,[]),t.get(r.parentId).push(r))}),t},[M]),K=$.useCallback(t=>de.get(t)||[],[de]),_=$.useMemo(()=>{const t=new Map;return q.forEach(r=>{const l=y[`expense-${r.id}`]||0,n=K(r.id).reduce((d,g)=>d+(y[`expense-${r.id}-${g.id}`]||0),0);t.set(r.id,l+n)}),t},[y,q,K]),me=$.useCallback(t=>_.get(t)||0,[_]),U=$.useMemo(()=>Array.from(_.values()).reduce((t,r)=>t+r,0),[_]),G=$.useMemo(()=>k.reduce((t,r)=>t+(y[`income-${r.id}`]||0),0),[y,k]);return e.jsxs("div",{className:"space-y-6 max-w-4xl mx-auto",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Receitas Previstas"}),e.jsx("div",{className:"space-y-2",children:k.map(t=>{const r=`income-${t.id}`,l=m[r]||"unique",f=C[r]||Q;return e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-3 p-3 border border-gray-200 dark:border-gray-700 rounded-lg hover:border-gray-300 dark:hover:border-gray-600 transition-colors group",children:[e.jsxs("div",{className:"flex items-center justify-between sm:flex-1",children:[e.jsx("span",{className:"text-gray-700 dark:text-gray-300 font-medium",children:t.name}),e.jsx("input",{type:"text",value:ee(r),onFocus:()=>te(r),onKeyDown:n=>{n.key>="0"&&n.key<="9"?(n.preventDefault(),W(r,n.key)):n.key==="Backspace"&&(n.preventDefault(),W(r,"Backspace"))},onBlur:()=>re(r,"income",void 0,void 0,t.id),className:"w-full sm:w-32 sm:ml-4 text-sm min-h-[44px] sm:min-h-0 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder:text-gray-400 dark:placeholder:text-gray-500 text-right font-semibold",placeholder:"R$ 0,00",readOnly:!0})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap sm:flex-shrink-0",children:[e.jsxs("select",{value:l,onChange:n=>se(r,n.target.value,"income",void 0,void 0,t.id),className:"text-sm border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"unique",children:"Único"}),e.jsx("option",{value:"recurring",children:"Recorrente"}),e.jsx("option",{value:"installment",children:"Parcelado"})]}),l==="installment"&&e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"number",min:"2",value:f,onChange:n=>ne(r,parseInt(n.target.value)||2,"income",void 0,void 0,t.id),className:"w-14 text-sm border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded px-2 py-1.5 text-center focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-500",children:"x"})]}),y[r]&&y[r]>0?e.jsx("button",{onClick:()=>ae(r,"income",void 0,void 0,t.id),className:"text-gray-400 hover:text-red-600 transition-colors w-5",title:"Remover orçamento",children:"✕"}):e.jsx("span",{className:"w-5"})]})]},t.id)})}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 flex justify-between items-center",children:[e.jsx("span",{className:"font-semibold text-gray-900 dark:text-white",children:"Total Previsto:"}),e.jsx("span",{className:"text-xl font-bold text-green-600 dark:text-green-400",children:V(G)})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Despesas Planejadas"}),e.jsx("div",{className:"space-y-3",children:q.map(t=>{const r=K(t.id),l=ce.has(t.id),f=me(t.id);return e.jsxs("div",{className:"border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden group",children:[e.jsx("div",{className:"bg-gray-50 dark:bg-gray-700/50 p-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors",onClick:()=>r.length>0&&ge(t.id),children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center gap-2 md:gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[r.length>0&&e.jsx("span",{className:"text-gray-600 dark:text-gray-400 text-sm",children:l?"▼":"▶"}),e.jsx("span",{className:"text-gray-900 dark:text-white font-semibold flex-1 md:min-w-[120px]",children:t.name})]}),e.jsxs("span",{className:"text-sm text-gray-700 dark:text-gray-300 font-medium md:min-w-[100px] md:text-right",children:["Total: ",V(f)]})]})}),l&&r.length>0&&e.jsx("div",{className:"p-3 pl-6 space-y-2 bg-white dark:bg-gray-800",children:r.map(n=>{const d=`expense-${t.id}-${n.id}`,g=m[d]||"unique",a=C[d]||Q;return e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2 group/sub",children:[e.jsxs("div",{className:"flex items-center justify-between sm:flex-1",children:[e.jsxs("span",{className:"text-gray-600 dark:text-gray-400 text-sm",children:["• ",n.name]}),e.jsx("input",{type:"text",value:ee(d),onFocus:()=>te(d),onKeyDown:u=>{u.key>="0"&&u.key<="9"?(u.preventDefault(),W(d,u.key)):u.key==="Backspace"&&(u.preventDefault(),W(d,"Backspace"))},onBlur:()=>re(d,"expense",t.id,n.id),className:"w-full sm:w-32 sm:ml-4 text-sm min-h-[44px] sm:min-h-0 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder:text-gray-400 dark:placeholder:text-gray-500 text-right font-semibold",placeholder:"R$ 0,00",readOnly:!0})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap sm:flex-shrink-0",children:[e.jsxs("label",{className:"flex items-center gap-1 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:H[d]||!1,onChange:u=>ue(d,u.target.checked,"expense",t.id,n.id),className:"w-3 h-3 text-primary-600 bg-gray-100 border-gray-300 rounded focus:ring-primary-500 focus:ring-2"}),e.jsx("span",{className:"text-xs text-gray-600 dark:text-gray-400",children:"Fixo"})]}),e.jsxs("select",{value:g,onChange:u=>se(d,u.target.value,"expense",t.id,n.id),className:"text-xs border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"unique",children:"Único"}),e.jsx("option",{value:"recurring",children:"Recorrente"}),e.jsx("option",{value:"installment",children:"Parcelado"})]}),g==="installment"&&e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"number",min:"2",value:a,onChange:u=>ne(d,parseInt(u.target.value)||2,"expense",t.id,n.id),className:"w-12 text-xs border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded px-2 py-1.5 text-center focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("span",{className:"text-xs text-gray-500",children:"x"})]}),y[d]&&y[d]>0?e.jsx("button",{onClick:()=>ae(d,"expense",t.id,n.id),className:"text-gray-400 hover:text-red-600 transition-colors w-5",title:"Remover orçamento",children:"✕"}):e.jsx("span",{className:"w-5"})]})]},n.id)})})]},t.id)})}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 flex justify-between items-center",children:[e.jsx("span",{className:"font-semibold text-gray-900 dark:text-white",children:"Total Planejado:"}),e.jsx("span",{className:"text-xl font-bold text-red-600 dark:text-red-400",children:V(U)})]})]}),e.jsx("div",{className:"bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-xl shadow-sm p-8 border border-blue-100 dark:border-blue-800",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Saldo Previsto:"}),e.jsx("span",{className:`text-2xl font-bold ${G-U>=0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"}`,children:V(G-U)})]})})]})},we=({categories:p,budgets:h,year:M,onMonthClick:k})=>{const[b,N]=$.useState(null),w=Array.from({length:12},(x,i)=>i+1),D=p.filter(x=>!x.parentId),y=(x,i,m="expense")=>{var B;return m==="income"?h.filter(C=>C.year===M&&C.month===x&&C.type==="income").reduce((C,Y)=>C+Y.amount,0):((B=h.find(C=>C.year===M&&C.month===x&&C.groupId===i&&C.type==="expense"))==null?void 0:B.amount)||0},o=(x,i="expense")=>w.reduce((m,B)=>m+y(B,x,i),0),s=o(void 0,"expense"),c=o(void 0,"income");return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden",children:[e.jsxs("button",{onClick:()=>N(b==="income"?null:"income"),className:"w-full p-4 flex items-center justify-between bg-green-50 dark:bg-green-900/20 hover:bg-green-100 dark:hover:bg-green-900/30 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-green-600 rounded-lg",children:e.jsx("svg",{className:"w-4 h-4 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})})}),e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:"text-sm font-bold text-green-900 dark:text-green-100",children:"Receitas"}),e.jsx("div",{className:"text-xs text-green-700 dark:text-green-300",children:I(c)})]})]}),e.jsx("svg",{className:`w-5 h-5 text-green-700 dark:text-green-300 transition-transform ${b==="income"?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),b==="income"&&e.jsx("div",{className:"p-4 bg-white dark:bg-gray-800 space-y-2",children:w.map(x=>{const i=y(x,void 0,"income");return i===0?null:e.jsxs("div",{onClick:()=>k(x),className:"flex justify-between items-center p-3 bg-green-50 dark:bg-green-900/10 rounded-lg cursor-pointer hover:bg-green-100 dark:hover:bg-green-900/20 transition-colors",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900 dark:text-white",children:O(x)}),e.jsx("span",{className:"text-sm font-bold text-green-600 dark:text-green-400",children:I(i)})]},x)})})]}),D.map(x=>{const i=o(x.id);return i===0?null:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden",children:[e.jsxs("button",{onClick:()=>N(b===x.id?null:x.id??null),className:"w-full p-4 flex items-center justify-between bg-gray-50 dark:bg-gray-700/50 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-purple-600 rounded-lg",children:e.jsx("svg",{className:"w-4 h-4 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"})})}),e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:"text-sm font-bold text-gray-900 dark:text-white",children:x.name}),e.jsx("div",{className:"text-xs text-gray-600 dark:text-gray-400",children:I(i)})]})]}),e.jsx("svg",{className:`w-5 h-5 text-gray-600 dark:text-gray-400 transition-transform ${b===x.id?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),b===x.id&&e.jsx("div",{className:"p-4 bg-white dark:bg-gray-800",children:e.jsx("div",{className:"flex overflow-x-auto gap-2 pb-2 scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-gray-600",children:w.map(m=>{const B=y(m,x.id);return e.jsxs("div",{onClick:()=>k(m),className:`flex-shrink-0 p-3 rounded-lg cursor-pointer transition-all min-w-[100px] ${B>0?"bg-purple-50 dark:bg-purple-900/20 border-2 border-purple-200 dark:border-purple-700 hover:bg-purple-100 dark:hover:bg-purple-900/30":"bg-gray-50 dark:bg-gray-700/30 border border-gray-200 dark:border-gray-600 opacity-40"}`,children:[e.jsx("div",{className:"text-xs text-gray-600 dark:text-gray-400 mb-1",children:O(m).substring(0,3)}),e.jsx("div",{className:`text-sm font-bold ${B>0?"text-purple-700 dark:text-purple-300":"text-gray-400 dark:text-gray-500"}`,children:B>0?I(B):"-"})]},m)})})})]},x.id)}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden",children:[e.jsxs("button",{onClick:()=>N(b==="expenses"?null:"expenses"),className:"w-full p-4 flex items-center justify-between bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-red-600 rounded-lg",children:e.jsx("svg",{className:"w-4 h-4 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20 12H4"})})}),e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:"text-sm font-bold text-red-900 dark:text-red-100",children:"Total Despesas"}),e.jsx("div",{className:"text-xs text-red-700 dark:text-red-300",children:I(s)})]})]}),e.jsx("svg",{className:`w-5 h-5 text-red-700 dark:text-red-300 transition-transform ${b==="expenses"?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),b==="expenses"&&e.jsx("div",{className:"p-4 bg-white dark:bg-gray-800 space-y-2",children:w.map(x=>{const i=h.filter(m=>m.year===M&&m.month===x&&m.type==="expense").reduce((m,B)=>m+B.amount,0);return i===0?null:e.jsxs("div",{onClick:()=>k(x),className:"flex justify-between items-center p-3 bg-red-50 dark:bg-red-900/10 rounded-lg cursor-pointer hover:bg-red-100 dark:hover:bg-red-900/20 transition-colors",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900 dark:text-white",children:O(x)}),e.jsx("span",{className:"text-sm font-bold text-red-600 dark:text-red-400",children:I(i)})]},x)})})]}),e.jsx("div",{className:"bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 border-2 border-blue-200 dark:border-blue-700",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-blue-700 dark:text-blue-300 font-medium mb-1",children:"Saldo Planejado Anual"}),e.jsx("div",{className:`text-2xl font-bold ${c-s>=0?"text-blue-600 dark:text-blue-400":"text-red-600 dark:text-red-400"}`,children:I(c-s)})]}),e.jsx("div",{className:`p-3 rounded-full ${c-s>=0?"bg-blue-600":"bg-red-600"}`,children:e.jsx("svg",{className:"w-6 h-6 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:c-s>=0?e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"}):e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})})]})},Ce=({budgets:p,categories:h,sources:M,year:k,onMonthClick:b})=>{const{isMobile:N}=ke(),w=h.filter(o=>!o.parentId),D=o=>{const s=p.filter(i=>i.year===k&&i.month===o),c=s.filter(i=>i.type==="income").reduce((i,m)=>i+m.amount,0),x=s.filter(i=>i.type==="expense").reduce((i,m)=>i+m.amount,0);return{income:c,expense:x,balance:c-x,hasData:s.length>0}},y=Array.from({length:12},(o,s)=>s+1);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4 sm:p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"p-2 bg-green-600 dark:bg-green-500 rounded-lg flex-shrink-0",children:e.jsx("svg",{className:"w-5 h-5 sm:w-6 sm:h-6 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"})})}),e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl sm:text-2xl font-bold text-gray-900 dark:text-white",children:["Visão Geral do Orçamento ",k]}),e.jsx("p",{className:"text-xs sm:text-sm text-gray-600 dark:text-gray-400",children:"Clique em qualquer mês para editar o orçamento detalhado"})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4",children:y.map(o=>{const s=D(o),c=s.balance>=0;return e.jsxs("div",{onClick:()=>b(o),className:`p-4 rounded-xl border-2 cursor-pointer transition-all hover:scale-105 hover:shadow-lg ${s.hasData?"border-blue-300 dark:border-blue-700 bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/30 dark:to-indigo-900/30 hover:border-blue-500 dark:hover:border-blue-600":"border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800/50 hover:border-gray-400 dark:hover:border-gray-600"}`,children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 dark:text-white mb-3",children:O(o)}),s.hasData?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-xs font-semibold text-green-600 dark:text-green-400 uppercase tracking-wider",children:"Receitas"}),e.jsx("span",{className:"text-sm font-bold text-green-700 dark:text-green-300",children:I(s.income)})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-xs font-semibold text-red-600 dark:text-red-400 uppercase tracking-wider",children:"Despesas"}),e.jsx("span",{className:"text-sm font-bold text-red-700 dark:text-red-300",children:I(s.expense)})]}),e.jsx("div",{className:"pt-2 border-t-2 border-blue-200 dark:border-blue-700/50",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider",children:"Saldo"}),e.jsx("span",{className:`text-sm font-bold ${c?"text-blue-700 dark:text-blue-300":"text-red-700 dark:text-red-300"}`,children:I(s.balance)})]})})]}):e.jsxs("div",{className:"text-center py-6",children:[e.jsx("div",{className:"mb-2",children:e.jsx("svg",{className:"w-8 h-8 mx-auto text-gray-400 dark:text-gray-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})})}),e.jsx("p",{className:"text-sm font-semibold text-gray-600 dark:text-gray-400",children:"Sem orçamento"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-500 mt-1",children:"Clique para criar"})]})]},o)})})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4 sm:p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"p-2 bg-purple-600 dark:bg-purple-500 rounded-lg flex-shrink-0",children:e.jsx("svg",{className:"w-4 h-4 sm:w-5 sm:h-5 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"})})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg sm:text-xl font-bold text-gray-900 dark:text-white",children:"Orçamento por Categoria"}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:N?"Toque para expandir categorias":"Distribuição mensal das categorias ao longo do ano"})]})]}),N?e.jsx(we,{categories:h,budgets:p,year:k,onMonthClick:b}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase",children:"Categoria"}),y.map(o=>e.jsx("th",{className:"px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase",children:O(o).substring(0,3)},o)),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase",children:"Total Ano"})]})}),e.jsxs("tbody",{className:"bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700",children:[e.jsxs("tr",{className:"bg-green-50 dark:bg-green-900/20",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-semibold text-green-900 dark:text-green-100",children:"Receitas"}),y.map(o=>{const s=D(o);return e.jsx("td",{onClick:()=>b(o),className:"px-2 py-3 text-center text-xs text-green-700 dark:text-green-300 cursor-pointer hover:bg-green-100 dark:hover:bg-green-900/40",children:s.income>0?I(s.income):"-"},o)}),e.jsx("td",{className:"px-4 py-3 text-right text-sm font-bold text-green-700 dark:text-green-300",children:I(y.reduce((o,s)=>o+D(s).income,0))})]}),w.map(o=>{const s=y.reduce((c,x)=>{const i=p.find(m=>m.year===k&&m.month===x&&m.groupId===o.id&&m.type==="expense");return c+((i==null?void 0:i.amount)||0)},0);return s===0?null:e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900 dark:text-white",children:o.name}),y.map(c=>{const x=p.find(i=>i.year===k&&i.month===c&&i.groupId===o.id&&i.type==="expense");return e.jsx("td",{onClick:()=>b(c),className:"px-2 py-3 text-center text-xs text-gray-700 dark:text-gray-300 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700",children:x?I(x.amount):"-"},c)}),e.jsx("td",{className:"px-4 py-3 text-right text-sm font-semibold text-gray-900 dark:text-white",children:I(s)})]},o.id)}),e.jsxs("tr",{className:"bg-red-50 dark:bg-red-900/20",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-semibold text-red-900 dark:text-red-100",children:"Total Despesas"}),y.map(o=>{const s=D(o);return e.jsx("td",{onClick:()=>b(o),className:"px-2 py-3 text-center text-xs text-red-700 dark:text-red-300 cursor-pointer hover:bg-red-100 dark:hover:bg-red-900/40",children:s.expense>0?I(s.expense):"-"},o)}),e.jsx("td",{className:"px-4 py-3 text-right text-sm font-bold text-red-700 dark:text-red-300",children:I(y.reduce((o,s)=>o+D(s).expense,0))})]}),e.jsxs("tr",{className:"bg-blue-50 dark:bg-blue-900/20 font-bold",children:[e.jsx("td",{className:"px-4 py-3 text-sm text-blue-900 dark:text-blue-100",children:"Saldo Planejado"}),y.map(o=>{const s=D(o);return e.jsx("td",{className:`px-2 py-3 text-center text-xs ${s.balance>=0?"text-blue-700 dark:text-blue-300":"text-red-700 dark:text-red-300"}`,children:s.hasData?I(s.balance):"-"},o)}),e.jsx("td",{className:"px-4 py-3 text-right text-sm text-blue-700 dark:text-blue-300",children:I(y.reduce((o,s)=>o+D(s).balance,0))})]})]})]})})]})]})},Me=async(p,h)=>{try{const k=(await E.budgets.toArray()).filter(s=>s.mode==="recurring"||s.mode==="installment"||s.isRecurrent&&!s.mode);if(k.length===0)return{success:!0,copiedCount:0};const b=R(p,h),N=k.filter(s=>R(s.year,s.month)<b);if(N.length===0)return{success:!0,copiedCount:0};const w=new Map;for(const s of N){const c=`${s.type}-${s.sourceId||""}-${s.groupId||""}-${s.subgroupId||""}`,x=R(s.year,s.month),i=w.get(c);if(!i)w.set(c,s);else{const m=R(i.year,i.month);x>m&&w.set(c,s)}}P.debug("Found recurring/installment budgets from previous months",{count:w.size});const D=await E.budgets.where("[year+month]").equals([p,h]).toArray(),y=new Set(D.map(s=>`${s.type}-${s.sourceId||""}-${s.groupId||""}-${s.subgroupId||""}`));let o=0;for(const[s,c]of w.entries()){if(y.has(s))continue;const x=c.mode||(c.isRecurrent?"recurring":"unique");if(x==="recurring"){const i={year:p,month:h,type:c.type,amount:c.amount,mode:"recurring",sourceId:c.sourceId,groupId:c.groupId,subgroupId:c.subgroupId};await E.budgets.add(i),o++}else if(x==="installment"){const i=R(c.year,c.month),m=c.installments||1,B=b-i;if(B<m){const C={year:p,month:h,type:c.type,amount:c.amount,mode:"installment",installments:c.installments,installmentNumber:B+1,sourceId:c.sourceId,groupId:c.groupId,subgroupId:c.subgroupId};await E.budgets.add(C),o++}}}return o>0&&P.info("Copied budgets to current month",{copiedCount:o,year:p,month:h}),{success:!0,copiedCount:o}}catch(M){return P.error("Failed to copy recurrent budgets",{error:M,year:p,month:h}),{success:!1,copiedCount:0,error:M instanceof Error?M:new Error("Unknown error occurred")}}},Re=()=>{const{categories:p,sources:h,budgets:M,selectedYear:k,selectedMonth:b,viewMode:N,setSelectedYear:w,setSelectedMonth:D,setViewMode:y,refreshBudgets:o}=le();$.useEffect(()=>{N!==T.MONTHLY&&N!==T.YEARLY&&y(T.MONTHLY)},[]);const s=x=>{D(x),y(T.MONTHLY)};$.useEffect(()=>{N===T.MONTHLY&&(async()=>(await Me(k,b),await o()))()},[k,b,N]);const c=e.jsxs("div",{className:"inline-flex items-center gap-1 p-1 bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/30 dark:to-indigo-900/30 rounded-lg border border-blue-200 dark:border-blue-800/50",children:[e.jsx("button",{onClick:()=>y(T.MONTHLY),className:`px-4 py-2 rounded-md font-semibold transition-all ${N===T.MONTHLY?"bg-blue-600 text-white shadow-md scale-105":"text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:scale-102"}`,children:"Mensal"}),e.jsx("button",{onClick:()=>y(T.YEARLY),className:`px-4 py-2 rounded-md font-semibold transition-all ${N===T.YEARLY?"bg-blue-600 text-white shadow-md scale-105":"text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:scale-102"}`,children:"Anual"})]});return e.jsx(je,{title:"Orçamento",description:N===T.MONTHLY?"Defina suas receitas previstas e despesas planejadas para o mês":"Visão geral do orçamento anual e planejamento mensal",action:c,children:e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"bg-white rounded-xl shadow-sm p-6",children:e.jsx(ve,{selectedYear:k,selectedMonth:b,onYearChange:w,onMonthChange:D,showMonths:N===T.MONTHLY})}),N===T.MONTHLY?e.jsx(Ne,{year:k,month:b}):e.jsx(Ce,{budgets:M,categories:p,sources:h,year:k,onMonthClick:s})]})})};export{Re as BudgetPage};
