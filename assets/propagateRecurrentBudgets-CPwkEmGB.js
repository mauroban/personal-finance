import{d as l,c as u,l as m}from"./index-DjoC8Tjb.js";const h=async(e,p=10)=>{if(e.mode!=="recurring")return 0;const y=e.year+p,a=u(e.year,e.month),s=await l.budgets.where(e.type==="expense"&&e.subgroupId?"[type+groupId+subgroupId]":e.type==="income"&&e.sourceId?"[type+sourceId]":"type").equals(e.type==="expense"&&e.subgroupId?[e.type,e.groupId||0,e.subgroupId]:e.type==="income"&&e.sourceId?[e.type,e.sourceId]:e.type).toArray(),t=new Map;s.forEach(n=>{const r=`${n.year}-${n.month}`;t.set(r,n)});const o=[];for(let n=e.year;n<=y;n++){const r=n===e.year?e.month+1:1,i=12;for(let c=r;c<=i;c++){if(u(n,c)<=a)continue;const d=`${n}-${c}`;t.has(d)||o.push({year:n,month:c,type:e.type,amount:e.amount,mode:"recurring",sourceId:e.sourceId,groupId:e.groupId,subgroupId:e.subgroupId,isFixedCost:e.isFixedCost})}}return o.length>0&&(await l.budgets.bulkAdd(o),m.info(`Propagated recurring budget to ${o.length} future months`,{budgetId:e.id,copiedCount:o.length})),o.length},f=async e=>{if(e.mode!=="installment"||!e.installments)return 0;const p=e.installments,y=await l.budgets.where(e.type==="expense"&&e.subgroupId?"[type+groupId+subgroupId]":e.type==="income"&&e.sourceId?"[type+sourceId]":"type").equals(e.type==="expense"&&e.subgroupId?[e.type,e.groupId||0,e.subgroupId]:e.type==="income"&&e.sourceId?[e.type,e.sourceId]:e.type).toArray(),a=new Map;y.forEach(t=>{const o=`${t.year}-${t.month}`;a.set(o,t)});const s=[];for(let t=1;t<p;t++){let o=e.year,n=e.month+t;for(;n>12;)n-=12,o++;const r=`${o}-${n}`;a.has(r)||s.push({year:o,month:n,type:e.type,amount:e.amount,mode:"installment",installments:e.installments,installmentNumber:t+1,sourceId:e.sourceId,groupId:e.groupId,subgroupId:e.subgroupId,isFixedCost:e.isFixedCost})}return s.length>0&&(await l.budgets.bulkAdd(s),m.info(`Propagated installment budget to ${s.length} months`,{budgetId:e.id,copiedCount:s.length,totalInstallments:p})),s.length},g=async e=>e.mode==="recurring"?await h(e):e.mode==="installment"?await f(e):0,$=async e=>{const y=(await l.budgets.toArray()).filter(t=>t.mode==="recurring"),a=new Map;y.forEach(t=>{const o=`${t.type}-${t.sourceId||""}-${t.groupId||""}-${t.subgroupId||""}`;a.has(o)||a.set(o,[]),a.get(o).push(t)});let s=0;for(const[,t]of a){const o=t.reduce((r,i)=>{const c=u(r.year,r.month);return u(i.year,i.month)<c?i:r}),n=Math.max(...t.map(r=>r.year));if(e>n){const r=e-o.year+2,i=await h(o,r);s+=i}}return s>0&&m.info(`Extended recurring budgets to year ${e}`,{budgetsExtended:s}),s};export{$ as ensureRecurringBudgetsForYear,g as propagateBudget,f as propagateInstallmentBudget,h as propagateRecurrentBudget};
